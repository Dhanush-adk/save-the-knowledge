# Fix "Server returned 401" in the app

The app gets **401** because Vercel is blocking the request before it reaches your API (Deployment Protection). Fix it in one of three ways.

---

## Option A: Make production public (fastest)

1. In Vercel: **Settings** → **Deployment Protection**.
2. Under **Vercel Authentication**, find **"Enabled for"** (dropdown next to Standard Protection).
3. Change it to **"Only Preview Deployments"** so that **Production** is not protected. Save.
4. Your production URL will now accept requests without auth. The app should work immediately.

---

## Option B: Protection Bypass for Automation (keep protection on)

Use this if you want to **keep** Vercel Authentication on for browser visitors but allow the app to send feedback.

1. In Vercel: **Settings** → **Deployment Protection** → **Protection Bypass for Automation**.
2. Create a bypass (or copy the existing secret). Vercel shows the header name: `x-vercel-protection-bypass` and the secret value.
3. **Redeploy** the feedback-server (`vercel --prod` from the feedback-server folder). The bypass secret is baked into deployments at build time; existing deployments won't accept the new secret until you redeploy.
4. In the KnowledgeCache app, open **`KnowledgeCache/Feedback/FeedbackConfig.swift`** and set the secret:
   ```swift
   static var protectionBypassSecret: String {
       "your-bypass-secret-from-vercel"  // paste the value from Vercel
   }
   ```
4. Rebuild and run; try **Send now** again. The app sends the header on every feedback and analytics request so Vercel allows the request through.

---

## Option C: Use production URL and make it public

1. **Get your production URL**
   - Open [Vercel Dashboard](https://vercel.com/dashboard) → your **feedback-server** project.
   - Go to **Deployments** and open the **Production** deployment (or the latest one you deployed with `vercel --prod`).
   - Copy the URL (e.g. `https://feedback-server-dhanushs-projects-acfd41f9.vercel.app`). It usually has **no** random hash in the middle (unlike preview URLs).

2. **Allow public access to production**
   - In the same project: **Settings** → **Deployment Protection**.
   - Set to **"Only Preview Deployments"** so that **Production** is not protected (and can be called by the app).
   - Save.

3. **Put the URL in the app**
   - In the KnowledgeCache repo open **`KnowledgeCache/Feedback/FeedbackConfig.swift`**.
   - Set `baseURL` to your production URL (no trailing slash).
   - Rebuild and run the app; try **Send now** again.

---

## Option D: Bypass protection for this project (Pro/Enterprise)

If you use **Deployment Protection Exceptions** (Pro with add-on or Enterprise):

- Add your **production** domain to **Deployment Protection Exceptions** so that domain is public.
- Use that same URL as `FeedbackConfig.baseURL` in the app.

---

## Check it works

**If using Option A (bypass secret):**
```bash
curl -X POST "https://YOUR-URL.vercel.app/api/feedback" \
  -H "Content-Type: application/json" \
  -H "x-vercel-protection-bypass: YOUR-BYPASS-SECRET" \
  -d '{"id":"test","message":"test","email":null,"type":"bug","app_version":"1.0","os_version":"14.0","timestamp":"2025-02-10T22:00:00.000Z"}'
```

**If using Option B (public production):**
```bash
curl -X POST "https://YOUR-PRODUCTION-URL.vercel.app/api/feedback" \
  -H "Content-Type: application/json" \
  -d '{"id":"test","message":"test","email":null,"type":"bug","app_version":"1.0","os_version":"14.0","timestamp":"2025-02-10T22:00:00.000Z"}'
```

- **200** and `{"ok":true}` → config is correct; app should work.
- **401** → protection still blocking; add bypass secret (Option A) or make production public (Option B).
